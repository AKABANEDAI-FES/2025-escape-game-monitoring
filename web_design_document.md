# 「だるまさんが転んだ」判定システム 設計書 (Webアプリケーション版)

## 1. 概要

本システムは、サーバーのPCに接続されたカメラの映像を利用し、「だるまさんが転んだ」のルールを自動判定するWebアプリケーションである。
サーバーサイドでプレイヤーの動きをリアルタイムで監視し、その結果をWebブラウザ上に表示する。

## 2. 機能要件

### 2.1. ゲーム状態管理 (サーバーサイド)
- **緑信号 (Green Light)状態**: プレイヤーが自由に動いて良い時間。
- **赤信号 (Red Light)状態**: プレイヤーが完全に静止しなければならない時間。
- サーバー上でこれらの状態を自動的に切り替える。

### 2.2. 映像処理 (サーバーサイド)
- サーバーに接続されたWebカメラから映像をリアルタイムで取得する。
- **赤信号状態**において、動体を検知する。
- 動きを検知した場合、ゲーム状態を「アウト」に更新する。

### 2.3. Webインターフェース (クライアントサイド)
- **映像表示**: サーバーからストリーミング配信されるカメラ映像をWebページに表示する。
- **状態表示**: 現在のゲーム状態（緑信号/赤信号/アウト）を画面に分かりやすく表示する。（例: 背景色の変更）
- **タイマー表示**: 次の状態に切り替わるまでの残り時間を表示する。

## 3. システム構成

- **バックエンド (Backend)**: Python / Flask / OpenCV
    - **Webサーバー**: Flaskを使用し、クライアントからのHTTPリクエストを処理する。
    - **ゲームロジック**: ゲームの状態（緑/赤/アウト、タイマー）を管理する。
    - **動体検知**: OpenCVを使い、カメラ映像から動きを検出する。
    - **APIエンドポイント (`/api/gamestate`)**: 現在のゲーム状態をJSON形式で提供する。
    - **ビデオストリーミングエンドポイント (`/video_feed`)**: 処理中のカメラ映像をMotion JPEG (MJPEG) 形式でストリーミング配信する。

- **フロントエンド (Frontend)**: HTML / CSS / JavaScript
    - **UI**: ゲームのメイン画面を構成する。
    - **スクリプト**: 定期的にバックエンドのAPI (`/api/gamestate`) に問い合わせ、受け取った情報をもとにUI（背景色、タイマー）を更新する。
    - **映像表示**: `<img>` タグを使用し、バックエンドの `/video_feed` エンドポイントから配信される映像を表示する。

## 4. 主要な処理フロー

### サーバーサイド (app.py)
1. Flaskアプリケーションを初期化し、Webサーバーを起動する。
2. ゲーム状態を管理する変数を初期化する。
3. 別スレッドでゲームのタイマーと状態（緑信号/赤信号）を定期的に更新する処理を開始する。
4. `/` へのアクセスに対し、メインのWebページ `templates/index.html` を返す。
5. `/video_feed` へのアクセスに対し、OpenCVでカメラを起動し、フレームを一枚ずつ取得する。
    - **赤信号状態**の場合、フレーム上で動体検知を実行する。
        - 動きを検知したら、ゲーム状態を「アウト」に設定する。
    - フレームをJPEG形式にエンコードし、HTTPレスポンスとしてクライアントに送信し続ける（MJPEGストリーム）。
6. `/api/gamestate` へのアクセスに対し、現在のゲーム状態（緑/赤/アウト、残り時間）をJSONで返す。

### クライアントサイド (index.html)
1. ユーザーがブラウザでWebページを開く。
2. ページの `<img>` タグが、サーバーの `/video_feed` に接続し、映像の表示を開始する。
3. JavaScriptの `setInterval` を使用して、一定間隔（例: 500msごと）でサーバーの `/api/gamestate` にリクエストを送信する。
4. サーバーから受け取ったゲーム状態のJSONデータをもとに、JavaScriptが以下の処理を行う。
    - 状態が「緑信号」なら、ページの背景を緑色にする。
    - 状態が「赤信号」なら、ページの背景を赤色にする。
    - 状態が「アウト」なら、「アウト」というメッセージを表示する。
    - 残り時間をページのタイマー表示部分に反映する。

## 5. プロジェクトのファイル構成案

```
.gitignore
app.py
requirements.txt
templates/
└── index.html
static/
├── css/
│   └── style.css
└── js/
    └── script.js
```

- `app.py`: Flaskアプリケーション本体。全てのバックエンド処理を記述。
- `requirements.txt`: `Flask` や `opencv-python` などの依存ライブラリを記載。
- `templates/index.html`: フロントエンドのHTMLファイル。
- `static/`: CSSやJavaScriptファイルを配置するディレクトリ（オプション）。
