# 「だるまさんが転んだ」判定システム 設計書 (Webアプリケーション版)

## 1. 概要

本システムは、PCに接続されたカメラの映像を利用する**3分間のタイムアタック形式**のWebアプリケーションである。プレイヤーは3分の持ち時間内に、赤信号で停止し、緑信号で進むルールに従う。赤信号中に動くと持ち時間が減らされる。持ち時間が0になるまでに、どれだけ耐えられるかに挑戦する。

## 2. 機能要件

### 2.1. ゲーム状態管理 (サーバーサイド)
- **ゲームモード**: 全体の持ち時間が3分（180秒）のタイムアタックモード。
- **状態遷移**:
    - **緑信号 (Green Light)状態**: 20秒間、プレイヤーは自由に動いて良い。
    - **赤信号 (Red Light)状態**: 20秒間、プレイヤーは完全に静止しなければならない。
- **ゲームオーバー**: 全体の持ち時間が0になった時点でゲームオーバーとなる。

### 2.2. 映像処理とペナルティ (サーバーサイド)
- サーバーに接続されたWebカメラから映像をリアルタイムで取得する。
- **赤信号状態**において、動体を検知する。
- 動きを検知した場合、即座にゲームオーバーにはせず、ペナルティとして**全体の持ち時間を5秒間減らす**。

### 2.3. Webインターフェース (クライアントサイド)
- **映像表示**: サーバーからストリーミング配信されるカメラ映像をWebページに表示する。
- **状態表示**: 現在のゲーム状態（緑信号/赤信号/ゲームオーバー）を画面に分かりやすく表示する。
- **タイマー表示**:
    - ゲーム全体の残り時間（`total_time`）を表示する。
    - 現在の状態（緑/赤）の残り時間（`interval_timer`）を表示する。

## 3. システム構成

- **バックエンド (Backend)**: Python / Flask / OpenCV
    - **Webサーバー**: Flaskを使用し、クライアントからのHTTPリクエストを処理する。
    - **ゲームロジック**: ゲームの状態（緑/赤/ゲームオーバー、各種タイマー）を管理する。
    - **動体検知**: OpenCVを使い、カメラ映像から動きを検出する。
    - **APIエンドポイント (`/api/gamestate`)**: 現在のゲーム状態をJSON形式で提供する。
    - **ビデオストリーミングエンドポイント (`/video_feed`)**: 処理中のカメラ映像をMotion JPEG (MJPEG) 形式でストリーミング配信する。

- **フロントエンド (Frontend)**: HTML / CSS / JavaScript
    - **UI**: ゲームのメイン画面を構成する。
    - **スクリプト**: 定期的にバックエンドのAPI (`/api/gamestate`) に問い合わせ、受け取った情報をもとにUI（背景色、タイマー）を更新する。
    - **映像表示**: `<img>` タグを使用し、バックエンドの `/video_feed` エンドポイントから配信される映像を表示する。

## 4. 主要な処理フロー

### サーバーサイド (app.py)
1. Flaskアプリケーションを初期化し、Webサーバーを起動する。
2. ゲーム状態を管理するグローバル変数 `game_state` を初期化する（`total_time: 180`, `interval_timer: 20` など）。
3. **単一の背景スレッド**で、1秒ごとに以下の処理を行うループを開始する。
    a. `total_time` と `interval_timer` を1秒減らす。
    b. `total_time` が0以下になったら、状態を `GAME_OVER` で終了。
    c. `interval_timer` が0以下になったら、状態を緑⇔赤で切り替え、`interval_timer` を20秒にリセットする。
4. `/video_feed` へのアクセスに対し、OpenCVでカメラ映像を配信する。
    - **赤信号状態**の場合、フレーム上で動体検知を実行する。
    - 動きを検知した場合、`game_state` の `total_time` を5秒減らす。
5. `/api/gamestate` へのアクセスに対し、現在の `game_state`（状態、残り時間など）をJSONで返す。

### クライアントサイド (index.html + script.js)
1. ユーザーがブラウザでWebページを開く。
2. JavaScriptが定期的に（例: 500msごと）`/api/gamestate` にリクエストを送信する。
3. 受け取ったJSONデータをもとに、**「全体の残り時間」**と**「インターバル」**の2つのタイマー表示を更新する。
4. ゲーム状態に応じて、背景色や「ゲームオーバー」メッセージの表示を切り替える。

## 5. プロジェクトのファイル構成案

```
.gitignore
app.py
requirements.txt
templates/
└── index.html
static/
├── css/
│   └── style.css
└── js/
    └── script.js
```

- `app.py`: Flaskアプリケーション本体。全てのバックエンド処理を記述。
- `requirements.txt`: `Flask` や `opencv-python` などの依存ライブラリを記載。
- `templates/index.html`: フロントエンドのHTMLファイル。
- `static/`: CSSやJavaScriptファイルを配置するディレクトリ（オプション）。
